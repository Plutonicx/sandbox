<html>
<head>
    <link href="static/content/bootstrap.min.css" rel="stylesheet" type="text/css" />

    <script src="static/scripts/jquery-1.8.3.min.js"></script>
    <script src="static/scripts/bootstrap-typeahead.js"></script>
    <script src="static/scripts/underscore-min.js"></script>

    <script>

    var new_products = null;

    function ajaxCallBack(product_obj) {
        new_products = product_obj;
    }

    $(document).ready(function($) {
        // Workaround for bug in mouse item selection
        $.fn.typeahead.Constructor.prototype.blur = function() {
            var that = this;
            setTimeout(function () { that.hide() }, 250);
        };

        var that = this;

        $('#product_search').typeahead({
            source: function(query, process) {
                $('#product').hide();

                $(function () {
                    $.ajax({
                        url: '{{ url_for("typeAhead") }}',
                        type: 'POST',
                        success: function (result) {
                            ajaxCallBack(JSON.parse(result));
                            //console.log(result);
                        }
                    });
                });

                var results = _.map(new_products, function (product) {
                    return product.name;
                });
                process(results);
            },

            //matcher: function(item) {
            //    return true;
            //},

            highlighter: function(name) {
                var product = _.find(new_products, function (p) {
                   return p.name == name;
                });

                html = '<div class="typeahead">';
                html += '<div class="media"><a class="pull-left" href="#"><img src=' + product.imgurl + ' /></a>'
                html += '<div class="media-body">';
                html += '<p class="media-heading">' + product.name + ' ($' + product.price + ')' + '</p>';
                html += '</div>';
                html += '</div>';

                //return product.name + " ($" + product.price + ")";
                return html;
            },

            updater: function(name) {
                var product = _.find(new_products, function (p) {
                    return p.name == name;
                });
                that.setSelectedProduct(product);
                return product.name;
            }

        });

        $('#product').hide();
        this.setSelectedProduct = function(product) {
            $('#product').html("Purchase: <strong>" + product.name + " ($" + product.price + ")</strong>").show();
        }
    })
    </script>
</head>
<body>

    <div style="margin: 50px 50px">
        <label for="product_search">Product Search: </label>
        <input id="product_search" type="text" data-provide="typeahead">
    </div>



</body>
</html>